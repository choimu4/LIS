<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LRS</title>
    <link rel="stylesheet" href="assets/css/map.css">
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=9f4efe1f08f0dc1b289457274270ae16&libraries=services"></script>
</head>

<body>
    <div class="map_wrap">
        <div id="map"></div>
        <div id="menu_wrap" class="bg_white">
            <hr>
            <ul id="placesList"></ul>
            <div id="pagination"></div>
        </div>
    </div>
    <div class="button_container">
        <button id="refreshButton">현재 위치에서 갱신</button>
        <button id="currentLocationButton">현재 위치로 이동</button>
    </div>
    <a href="index.html" id="homeButton" title="Home">
        <img src="assets/image/home-icon.png" alt="Home">
    </a>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var markers = [];
            var map, infowindow, ps;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(initMap, showError);
            } else {
                alert('Geolocation is not supported by this browser.');
            }

            function initMap(position) {
                var lat = position.coords.latitude,
                    lon = position.coords.longitude;
                var locPosition = new kakao.maps.LatLng(lat, lon);

                // 지도의 초기 설정
                var mapOption = {
                    center: locPosition,
                    level: 3 // 초기 줌 레벨
                };

                map = new kakao.maps.Map(document.getElementById('map'), mapOption);
                infowindow = new kakao.maps.InfoWindow({ zIndex: 1 });
                ps = new kakao.maps.services.Places();

                displayMarker(locPosition);

                document.getElementById('refreshButton').addEventListener('click', function () {
                    searchPlaces();
                });

                document.getElementById('currentLocationButton').addEventListener('click', function () {
                    navigator.geolocation.getCurrentPosition(function (position) {
                        var lat = position.coords.latitude,
                            lon = position.coords.longitude;
                        var locPosition = new kakao.maps.LatLng(lat, lon);
                        map.setCenter(locPosition);
                    });
                });
            }

            function showError(error) {
                alert('Geolocation error: ' + error.message);
            }

            function displayMarker(locPosition) {
                var marker = new kakao.maps.Marker({
                    map: map,
                    position: locPosition
                });
                map.setCenter(locPosition);
            }

            function searchPlaces() {
                var bounds = map.getBounds();
                var keyword = '코인세탁소';

                var placesSearchOption = {
                    bounds: bounds
                };

                ps.keywordSearch(keyword, placesSearchCB, placesSearchOption);
            }

            function placesSearchCB(data, status, pagination) {
                if (status === kakao.maps.services.Status.OK) {
                    displayPlaces(data);
                    displayPagination(pagination);
                } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
                    alert('검색 결과가 존재하지 않습니다.');
                } else if (status === kakao.maps.services.Status.ERROR) {
                    alert('검색 결과 중 오류가 발생했습니다.');
                }
            }

            function displayPlaces(places) {
                var listEl = document.getElementById('placesList'),
                    fragment = document.createDocumentFragment(),
                    bounds = new kakao.maps.LatLngBounds();

                removeAllChildNodes(listEl);
                removeMarker();

                places.forEach(function (place, i) {
                    var placePosition = new kakao.maps.LatLng(place.y, place.x),
                        marker = addMarker(placePosition, i),
                        itemEl = getListItem(i, place);

                    bounds.extend(placePosition);

                    (function (marker, title) {
                        kakao.maps.event.addListener(marker, 'mouseover', function () {
                            displayInfowindow(marker, title);
                        });
                        kakao.maps.event.addListener(marker, 'mouseout', function () {
                            infowindow.close();
                        });
                        itemEl.onmouseover = function () {
                            displayInfowindow(marker, title);
                        };
                        itemEl.onmouseout = function () {
                            infowindow.close();
                        };
                    })(marker, place.place_name);

                    fragment.appendChild(itemEl);
                });

                listEl.appendChild(fragment);
            }

            function displayPagination(pagination) {
                var paginationEl = document.getElementById('pagination'),
                    fragment = document.createDocumentFragment(),
                    i;

                // 기존 페이지번호 삭제
                while (paginationEl.hasChildNodes()) {
                    paginationEl.removeChild(paginationEl.lastChild);
                }

                for (i = 1; i <= pagination.last; i++) {
                    var el = document.createElement('a');
                    el.href = "#";
                    el.innerHTML = i;

                    if (i === pagination.current) {
                        el.className = 'on';
                    } else {
                        el.onclick = (function (i) {
                            return function () {
                                pagination.gotoPage(i);
                            }
                        })(i);
                    }

                    fragment.appendChild(el);
                }
                paginationEl.appendChild(fragment);
            }

            function getListItem(index, place) {
                var el = document.createElement('li'),
                    itemStr = '<span class="markerbg marker_' + (index + 1) + '"></span>' +
                        '<div class="info">' +
                        '<h5>' + place.place_name + '</h5>';

                if (place.road_address_name) {
                    itemStr += '<span>' + place.road_address_name + '</span>' +
                        '<span class="jibun gray">' + place.address_name + '</span>';
                } else {
                    itemStr += '<span>' + place.address_name + '</span>';
                }

                itemStr += '<span class="tel">' + place.phone + '</span></div>';

                el.innerHTML = itemStr;
                el.className = 'item';

                return el;
            }

            function addMarker(position, idx) {
                var imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_blue.png',
                    imageSize = new kakao.maps.Size(36, 37),
                    imgOptions = {
                        spriteSize: new kakao.maps.Size(36, 691),
                        spriteOrigin: new kakao.maps.Point(0, (idx * 46) + 10),
                        offset: new kakao.maps.Point(13, 37)
                    };
                var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imgOptions);
                var marker = new kakao.maps.Marker({
                    position: position,
                    image: markerImage
                });

                marker.setMap(map);
                markers.push(marker);

                return marker;
            }

            function removeMarker() {
                markers.forEach(function (marker) {
                    marker.setMap(null);
                });
                markers = [];
            }

            function removeAllChildNodes(el) {
                while (el.hasChildNodes()) {
                    el.removeChild(el.lastChild);
                }
            }

            function displayInfowindow(marker, title) {
                var content = '<div style="padding:5px;z-index:1;">' + title + '</div>';
                infowindow.setContent(content);
                infowindow.open(map, marker);
            }
        });
    </script>
</body>

</html>
